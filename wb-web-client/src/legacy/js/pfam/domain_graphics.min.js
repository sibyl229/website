$jq=jQuery.noConflict(),Array.max=function(e){return Math.max.apply(Math,e)},Array.prototype.flatten=function(){return $jq.map(this,function(e){if(e)return e})};var PfamGraphic={_canvases:{},_middleClickListenerAdded:!1,initialize:function(e,t){this._imageParams={headSizeCircle:3,headSizeSquare:6,headSizeDiamond:4,headSizeArrow:3,headSizePointer:3,headSizeLine:3,sequenceEndPadding:2,xOffset:0,yOffset:0,defaultMarkupHeight:20,lollipopToLollipopIncrement:7,bridgeToBridgeIncrement:2,bridgeToLollipopIncrement:5,largeJaggedSteps:6,fontSize:"0.8em",regionHeight:20,motifHeight:14,motifOpacity:.6,labelPadding:3,residueWidth:.5,xscale:1,yscale:1,envOpacity:.6,highlightWeight:1,highlightColour:"#000000"},this._options={baseUrl:"",imageMap:!0,labels:!0,tips:!0,tipStyle:"pfam",newCanvas:!0},this._markupSpec={valignValues:["top","bottom"],linesStyleValues:["mixed","bold","dashed"],lollipopHeadValues:["diamond","circle","square","arrow","pointer","line"],regionEndValues:["curved","straight","jagged","arrow"]},this._heights={},this._areasHash={},this._cache={},e!==undefined&&this.setParent(e),t!==undefined&&this.setSequence(t),this._saveLevel=0},setParent:function(e){return this._parent=$jq(e),(this._parent===undefined||this._parent===null)&&this._throw("couldn't find the parent node"),this},getParent:function(){return this._parent},setCanvas:function(e){return this._canvas=e,(this._canvas===undefined||this._canvas===null)&&this._throw("couldn't find the canvas node"),this._canvas.getContext==undefined&&(this._throw("canvas is not supported"),alert("test")),this._context=this._canvas.getContext("2d"),this._context===undefined&&this._throw("couldn't create a 2d context from canvas"),this._areasList=[],this},getCanvas:function(){return this._canvas},setImageParams:function(e){return this._imageParams=e,this._applyImageParams=!0,this},getImageParams:function(){return this._imageParams},setNewCanvas:function(e){return this._options.newCanvas=e,this},getNewCanvas:function(){return this._options.newCanvas},setBaseUrl:function(e){return this._options.baseUrl=e,this},getBaseUrl:function(){return this._options.baseUrl},setSequence:function(e){return e.length===undefined&&this._throw("must specify a sequence length"),isNaN(e.length)&&this._throw("sequence length must be a valid number"),parseInt(e.length,10)<=0&&this._throw("sequence length must be a positive integer"),e.regions!==undefined?typeof e.regions!="object"&&this._throw("'regions' must be a valid object"):e.regions=[],e.markups!==undefined?typeof e.markups!="object"&&this._throw("'markups' must be a valid object"):e.markups=[],e.motifs!==undefined?typeof e.motifs!="object"&&this._throw("'motifs' must be a valid object"):e.motifs=[],e.options!==undefined&&(typeof e.options!="object"&&this._throw("'options' must be a valid object"),this._options=Object.extend(this._options,e.options)),e.imageParams!==undefined&&(typeof e.imageParams!="object"&&this._throw("'imageParams' must be a valid object"),this.setImageParams(e.imageParams)),this._sequence=JSON.parse(e),this._walkSequence(),this._imageWidth=this._sequence.length*this._imageParams.residueWidth+2,this._regionHeight=this._imageParams.regionHeight,this._seqHeight=Math.round(this._regionHeight/6),this._seqStep=Math.round(this._seqHeight/5),this._buildMarkups(),this._canvasHeight=Array.max([this._heights.lollipops.upMax,this._heights.bridges.upMax,this._regionHeight/2+1])+Array.max([this._heights.lollipops.downMax,this._heights.bridges.downMax,this._regionHeight/2+1])+1,this._canvasHeight*=this._imageParams.yscale,this._sequence.highlight!==undefined&&(this._canvasHeight+=5+Math.ceil(this._imageParams.highlightWeight/2)),this._canvasWidth=this._imageWidth+1+this._imageParams.sequenceEndPadding*2,this._canvasWidth*=this._imageParams.xscale,this._baseline=Array.max([this._heights.lollipops.upMax||0,this._heights.bridges.upMax||0,(this._imageParams.regionHeight||0)/2])+1,this},getSequence:function(){return this._sequence},getDimensions:function(){if(this._canvasWidth===undefined||this._canvasHeight===undefined)return null;var e=[this._canvasWidth,this._canvasHeight];return e.width=this._canvasWidth,e.height=this._canvasHeight,e},getBaseline:function(){return this._baseline===undefined?null:this._baseline},getAreas:function(){return[this._areasList,this._areasHash]},render:function(e,t){try{return t!==undefined&&this.setSequence(t),e!==undefined&&this.setParent(e),this._sequence===undefined&&this._throw("sequence was not supplied"),this._options.newCanvas&&this._parent===undefined&&this._throw("parent node was not supplied"),(!this._canvas||this._options.newCanvas)&&this._buildCanvas(this._canvasWidth,this._canvasHeight),this._draw(),this._canvases[this._canvas]={parentEl:this._parent,areas:this._areasList},this}catch(n){$jq(e).text(n.name+": "+n.message).addClass("ui-state-error")}},_throw:function(e){throw{name:"PfamGraphicException",message:e,toString:function(){return this.message}}},_walkSequence:function(){var e=this._sequence;e.length=this._parseInt(e.length);for(j in[e.motifs,e.regions,e.markups])for(i in["start","end","aliStart","aliEnd"])i=this._parseInt(i)},_parseInt:function(e){if(e===undefined)return;var t=parseInt(e,10);return t!=="NaN"?t:e},_buildCanvas:function(e,t){var n=document.createElement("canvas");n.width=e,n.height=t,$jq(this._parent).append(n),typeof G_vmlCanvasManager!="undefined"&&(n=G_vmlCanvasManager.initElement(n));var r=this._parent.closest("div");r&&e>r.scrollWidth&&this._parent.addClassName("canvasScroller"),this.setCanvas(n)},_addListeners:function(){var e=window.Prototip&&this._options.tips;this._inside=null,$jq(this._canvas).click(function(e){this._handleClick(e)}.bind(this))},_handleClick:function(e){var t=e.findElement("canvas"),n=t.identify(),r=this._canvases[n];if(r===undefined)return;e.stop();var i=r.areas,s=t.cumulativeOffset(),o=s[0],u=s[1],a=e.pointerX()-o,f=e.pointerY()-u,l=null;i.reverse().each(function(e){if(a>e.coords[0]&&a<e.coords[2]&&f>e.coords[1]&&f<e.coords[3])throw l=e,$break});if(l&&l.href){var c;this._options.baseUrl&&!this._options.baseUrl.empty()?c=this._options.baseUrl+l.href:c=l.href,e.isMiddleClick()?window.open(c):window.location=c}},_buildMarkups:function(){var e={lollipops:{up:[],down:[],markups:[],downMax:0,upMax:0},bridges:{up:[],down:[],markups:[],downMax:0,upMax:0}},t=[],n=this._imageParams,r=this._markupSpec,i={},s=this._sequence.markups;for(var o=-1,u;u=s[++o];){var a=Math.floor(u.start);a==="NaN"&&this._throw("markup start position is not a number: '"+u.start+"'"),i[u.start]===undefined&&(i[u.start]=[]),i[u.start].push(u)}i=$jq.map(i,function(e){if(e)return e});var f=this._imageParams.residueWidth;for(var o=-1,u;u=i[++o];){if(typeof u!="object")continue;var a=Math.floor(u.start);a==="NaN"&&this._throw("markup start position is not a number: '"+u.start+"'");if(u.end!==undefined){t.push(u);continue}e.lollipops.markups.push(u),u.v_align!==undefined&&!r.valignValues.include(u.v_align)&&this._throw("markup 'v_align' value is not valid: '"+u.v_align+"'"),u.headStyle!==undefined&&!($jq.inArray(u.headStyle,r.lollipopHeadValues)>-1)&&this._throw("markup 'headStyle' value is not valid: '"+u.headStyle+"'");var l=u.v_align===undefined||u.v_align==="top",c=l?e.lollipops.up:e.lollipops.down;if(c[a-1/f]!==undefined||c[a]!==undefined||c[a+1/f]!==undefined){var h=Array.max(c.slice(a-1/f,a+1/f));c[a]=h+n.lollipopToLollipopIncrement}else c[a]=n.defaultMarkupHeight;var p=n["headSize"+u.headStyle.charAt(0).toUpperCase()+u.headStyle.slice(1)];l?e.lollipops.upMax=Math.max(c[a]+p,e.lollipops.upMax):e.lollipops.downMax=Math.max(c[a]+p,e.lollipops.downMax)}for(var o=-1,d;d=t[++o];){var v={markup:d};e.bridges.markups.push(v);var a=Math.floor(d.start);a==="NaN"&&this._throw("bridge start position is not a number: '"+d.start+"'");var m=Math.floor(d.end);m==="NaN"&&this._throw("bridge end position is not a number: '"+d.end+"'"),v.up=d.v_align===undefined||d.v_align==="top";var g=v.up?e.lollipops.up:e.lollipops.down,y=v.up?e.bridges.up:e.bridges.down,b=Array.max(y.slice(a,m).flatten()),w=n.defaultMarkupHeight;b!==undefined&&$jq.inArray(w,y.slice(a,m).flatten())>-1&&(w=b+n.bridgeToBridgeIncrement);var E=Array.max(g.flatten().slice(a-4,m+4));E!==undefined&&E+n.bridgeToLollipopIncrement>=w&&(w=E+n.bridgeToLollipopIncrement);while($jq.inArray(w,y.slice(a,m).flatten())>-1)w+=n.bridgeToBridgeIncrement,console.log("PfamGraphic._buildMarkups: found overlapping bridge; setting bridge height to %d",w);v.height=w;for(var S=a;S<m+1;S++)y[S]===undefined&&(y[S]=[]),y[S].push(w);v.up?e.bridges.upMax=Math.max(w,e.bridges.upMax)+2:e.bridges.downMax=Math.max(w,e.bridges.downMax)+2}this._heights=e},_draw:function(){this._context.save();if(this._applyImageParams){var e=this._imageParams;this._context.translate(e.xOffset,e.yOffset),this._context.scale(e.xscale,e.yscale),this._context.translate(e.sequenceEndPadding,0),this._applyImageParams=!1}var t=this._drawSequence();for(var n=-1,r;r=this._heights.bridges.markups[++n];){if(r.display!==undefined&&r.display!==null&&!r.display)continue;this._drawBridge(r)}for(var n=-1,i;i=this._heights.lollipops.markups.reverse()[++n];){if(i.display!==undefined&&i.display!==null&&!i.display)continue;this._drawLollipop(i)}for(var n=-1,s;s=this._sequence.regions[++n];){if(s.display!==undefined&&s.display!==null&&!s.display)continue;this._drawRegion(s)}if(this._sequence.motifs)for(var n=-1,o;o=this._sequence.motifs[++n];){if(o.display!==undefined&&o.display!==null&&!o.display)continue;this._drawMotif(o)}this._sequence.highlight!==undefined&&parseInt(this._sequence.highlight.start,10)&&parseInt(this._sequence.highlight.end,10)&&this._drawHighlight(),this._context.restore()},_drawSequence:function(){this._topOffset=Math.floor(this._baseline-this._seqHeight/2),this._botOffset=Math.floor(this._baseline+this._seqHeight/2+1),this._context.save();var e=this._context.createLinearGradient(1,this._topOffset,1,this._botOffset);e.addColorStop(0,"#999999"),e.addColorStop(.5,"#eeeeee"),e.addColorStop(.7,"#cccccc"),e.addColorStop(1,"#999999"),this._context.fillStyle=e,this._context.fillRect(1,this._topOffset+.5,this._imageWidth-1,this._seqHeight/2*3),this._context.restore();var t=this._imageParams.xOffset,n=this._imageParams.yOffset;return{label:"sequence",text:"sequence",coords:[t,n+this._topOffset,t+this._imageWidth,n+this._topOffset+this._seqStep*5]}},_drawLollipop:function(e){var t=e.start,n=e.v_align===undefined||e.v_align==="top",r=Math.floor(t*this._imageParams.residueWidth)+1.5,i,s;n?(i=Math.round(this._topOffset+1)-.5,s=Math.floor(i-this._heights.lollipops.up[t]+(this._baseline-this._topOffset)+1)):(i=Math.round(this._botOffset+1)-.5,s=Math.ceil(i+this._heights.lollipops.down[t]-(this._botOffset-this._baseline)-1)),this._context.save(),this._context.beginPath(),this._context.moveTo(r,i),this._context.lineTo(r,s),this._context.strokeStyle=e.lineColour||"#000000",this._context.stroke(),this._context.closePath(),this._context.restore();var o=this._imageParams.xOffset,u=this._imageParams.yOffset,a=[i,s].sort(function(e,t){return e-t}),f={start:t,type:"lollipop",coords:[o+Math.floor(r)-1,u+a[0]-1,o+Math.floor(r)+1,u+a[1]+1]};this._areasList.push(f),e.href!==undefined&&(f.href=e.href);var l={};if(e.metadata){var c=e.metadata;l.title=c.type||"Annotation",l.body='<div class="tipContent">  <dl>    <dt>Description:</dt>    <dd>'+c.description+"</dd>"+"    <dt>Position:</dt>"+"    <dd>"+c.start+"</dd>"+"    <dt>Source:</dt>"+"    <dd>"+(c.database||'<span class="na">n/a</span>')+"</dd>"+"  </dl>"+"</div>"}f.tip=l,e.headStyle&&this._drawLollipopHead(r,i,s,t,n,e.headStyle,e.colour,e.lineColour,f.tip,e.metadata)},_drawLollipopHead:function(e,t,n,r,i,s,o,u,a,f){var l=this._imageParams.xOffset,c=this._imageParams.yOffset,h,p;this._context.save();switch(s){case"circle":h=this._imageParams.headSizeCircle,this._context.beginPath(),this._context.arc(e,n,h,0,Math.PI*2,"true"),this._context.fillStyle=o||"red",this._context.fill(),this._areasList.push({tip:a,type:"lollipop-head",shape:"circle",colour:o||"red",start:r,coords:[l+e-h,c+n-h,l+e+h,c+n+h]});break;case"square":p=this._imageParams.headSizeSquare/2,this._context.beginPath(),this._context.moveTo(e-p,n-p),this._context.lineTo(e-p,n+p),this._context.lineTo(e+p,n+p),this._context.lineTo(e+p,n-p),this._context.lineTo(e-p,n-p),this._context.closePath(),this._context.fillStyle=o||"rgb(100, 200, 9)",this._context.fill(),this._areasList.push({tip:a,type:"lollipop-head",start:r,colour:o||"rgb(100, 200, 9)",coords:[l+e-p,c+n-p,l+e+p,c+n+p]});break;case"diamond":p=this._imageParams.headSizeDiamond,this._context.beginPath(),this._context.moveTo(e-p,n),this._context.lineTo(e,n+p),this._context.lineTo(e+p,n),this._context.lineTo(e,n-p),this._context.lineTo(e-p,n),this._context.closePath(),this._context.fillStyle=o||"rgb(100, 200, 9)",this._context.fill(),this._areasList.push({tip:a,ty2pe:"lollipop-head",shape:"poly",start:r,colour:o||"rgb(100, 200, 9)",coords:[l+e-p,c+n-p,l+e+p,c+n+p]});break;case"line":p=this._imageParams.headSizeLine,this._context.beginPath(),this._context.moveTo(e,n-p),this._context.lineTo(e,n+p),this._context.closePath(),this._context.strokeStyle=o||"rgb(50, 40, 255)",this._context.stroke(),this._areasList.push({tip:a,type:"lollipop-head",start:r,colour:o||"rgb(50, 40, 255)",coords:[l+e-1,c+n-p-1,l+e+1,c+n+p+1]});break;case"arrow":p=this._imageParams.headSizeArrow;var d;i?(this._context.beginPath(),this._context.moveTo(e,n),this._context.lineTo(e,n-p),this._context.strokeStyle=u||"#000000",this._context.stroke(),this._context.beginPath(),this._context.moveTo(e-p,n+p*.5),this._context.lineTo(e,n-p),this._context.lineTo(e+p,n+p*.5),d=[l+e-p,c+n,l+e+p,c+n+p*.5]):(this._context.beginPath(),this._context.moveTo(e,n),this._context.lineTo(e,n+p),this._context.strokeStyle=u||"#000000",this._context.stroke(),this._context.beginPath(),this._context.moveTo(e-p,n-p*.5),this._context.lineTo(e,n+p),this._context.lineTo(e+p,n-p*1.5),d=[l+e-p,c+n-p*1.5,l+e+p,c+n-p]),this._context.strokeStyle=o||"rgb(50, 40, 255)",this._context.stroke(),this._areasList.push({tip:a,type:"lollipop-head",colour:o||"rgb(50, 40, 255)",start:r,shape:"poly",coords:d});break;case"pointer":p=this._imageParams.headSizePointer,this._context.beginPath();var d;i?(this._context.moveTo(e-p,t-p*1.5),this._context.lineTo(e,t),this._context.lineTo(e+p,t-p*1.5),d=[l+e-p,c+t,l+e+p,c+t-p]):(this._context.moveTo(e-p,t+p*1.5),this._context.lineTo(e,t),this._context.lineTo(e+p,t+p*1.5),d=[l+e-p,c+t+p,l+e+p,c+t]),this._context.strokeStyle=o||"rgb(50, 40, 255)",this._context.stroke(),this._areasList.push({tip:a,type:"lollipop-head",colour:o||"rgb(50, 40, 255)",start:r,shape:"poly",coords:d})}this._context.restore()},_drawBridge:function(e){this._context.save();var t=e.markup.start,n=e.markup.end,r=e.height,i=e.up,s="#000000",o=Math.floor(t*this._imageParams.residueWidth)+1.5,u=Math.floor(n*this._imageParams.residueWidth)+1.5,a=Math.round(i?this._topOffset:this._botOffset)+.5,f,l,c=this._imageParams.xOffset,h=this._imageParams.yOffset;i?f=Math.ceil(this._baseline-r)-.5:f=Math.floor(this._baseline+r)+.5,this._context.beginPath(),this._context.moveTo(o,a),this._context.lineTo(o,f),this._context.lineTo(u,f),this._context.lineTo(u,a),this._context.strokeStyle=e.markup.colour,this._context.stroke(),this._context.closePath(),this._context.restore();var p={};if(e.markup.metadata){var d=e.markup.metadata;p.title=d.type||"Bridge",p.body='<div class="tipContent">  <dl>    <dt>Coordinates:</dt>    <dd>'+d.start+"-"+d.end+"</dd>"+"    <dt>Source:</dt>"+"    <dd>"+(d.database||'<span class="na">n/a</span>')+"</dd>"+"  </dl>"+"</div>"}var v=[a,f].sort(function(e,t){return e-t});this._areasList.push({start:t,type:"bridge-start",colour:s,end:n,tip:p,coords:[c+o-1,h+v[0]-1,c+o+1,h+v[1]+1]}),this._areasList.push({start:t,type:"bridge-horizontal",colour:s,end:n,tip:p,coords:[c+o-1,h+v[0],c+u+1,h+v[0]+2]}),this._areasList.push({start:t,type:"bridge-end",colour:s,end:n,tip:p,coords:[c+u-1,h+v[0]-1,c+u+1,h+v[1]+1]})},_drawRegion:function(e){$jq.inArray(e.startStyle,this._markupSpec.regionEndValues)>-1||this._throw("region start style is not valid: '"+e.startStyle+"'"),$jq.inArray(e.endStyle,this._markupSpec.regionEndValues)>-1||this._throw("region end style is not valid: '"+e.endStyle+"'");var t=Math.floor(this._regionHeight)-2,n=Math.round(t/2),r=n,i=(e.end-e.start+1)*this._imageParams.residueWidth,s=Math.max(1,Math.floor(e.start*this._imageParams.residueWidth)+1),o=Math.floor(this._baseline-n)+.5,u={x:s,y:o,w:i,h:t,r:n,a:r,s:e.startStyle,e:e.endStyle},a=this._context.createLinearGradient(s,o,s,o+t);a.addColorStop(0,"#ffffff"),a.addColorStop(.5,e.colour),a.addColorStop(.7,e.colour),a.addColorStop(1,"#ffffff"),this._context.save(),this._context.beginPath(),this._buildRegionPath(u),this._context.fillStyle=a,this._context.fill();var f;e.aliStart!==undefined&&e.aliEnd!==undefined&&(f=this._drawEnvelope(e,n,t)),this._context.strokeStyle=e.colour,this._context.stroke(),this._context.closePath(),this._context.beginPath(),this._context.moveTo(0,this._topOffset),this._context.lineTo(0,this._botOffset),this._context.strokeStyle="white",this._context.stroke(),this._context.closePath(),this._options.labels&&this._drawText(s,this._baseline,i,e.text),this._context.restore();var l=this._imageParams.xOffset,c=this._imageParams.yOffset,h={text:e.text,type:"region",start:e.start,end:e.end,colour:e.colour,aliStart:e.aliStart,aliEnd:e.aliEnd,coords:[l+s,c+o,l+s+i+1,c+o+t]};this._areasList.push(h),this._areasHash["region_"+e.text+"_"+e.start+"_"+e.end]=h,e.href!==undefined&&(h.href=e.href),this._buildTip(e,h)},_buildTip:function(e,t){if(e.metadata===undefined)return;var n=e.metadata,r;n.accession!==undefined&&n.identifier!==undefined?r=n.identifier+" ("+n.accession.toUpperCase()+")":n.identifier!==undefined?r=n.identifier:n.accession!==undefined?r=n.accession.toUpperCase():r=n.type;var i='<span class="inactive">n/a</span>';n.start!==undefined&&n.end!==undefined&&(i=n.start+" - "+n.end,n.aliStart!==undefined&&n.aliEnd!==undefined&&(i=i.concat(" (alignment region "+n.aliStart+" - "+n.aliEnd+")")));var s='<div class="tipContent">  <dl>    <dt>Description:</dt>    <dd>'+(n.description||'<span class="inactive">n/a</span>')+"</dd>"+"    <dt>Coordinates:</dt>"+"    <dd>"+i+"</dd>"+"    <dt>Source:</dt>"+"    <dd>"+(n.database||'<span class="na">n/a</span>')+"</dd>"+"  </dl>"+"</div>";t.tip={title:r,body:s}},_drawMotif:function(e){e.start=parseInt(e.start,10),e.end=parseInt(e.end,10);var t=this._imageParams.motifHeight,n=Math.floor((e.end-e.start+1)*this._imageParams.residueWidth)+1,r=Math.max(1,Math.floor((e.start+1)*this._imageParams.residueWidth)),i=Math.floor(this._baseline-Math.round(t/2));this._context.save();var s;if(e.colour instanceof Array){e.colour.length!==3&&this._throw("motifs must have either one or three colours"),colour=[];var o=this._getRGBColour.bind(this),u=this._imageParams;e.colour.each(function(e){var t=o(e);colour.push({rgb:"rgb("+t.join(",")+")",rgba:"rgba("+t.join(",")+","+u.motifOpacity+")"})});var a=Math.round(t/3);for(var f=0;f<3;f+=1)this._context.fillStyle=colour[f].rgb,this._context.fillRect(r,i+a*f,n,a)}else{colour=this._getRGBColour(e.colour);var l="rgb("+colour.join(",")+")",c="rgba("+colour.join(",")+","+this._imageParams.motifOpacity+")";this._context.fillStyle=c,this._context.fillRect(r,i,n,parseInt(t,10)+1)}this._context.restore();var h;e.metadata!==undefined&&e.metadata.identifier!==undefined?h=e.metadata.identifier:e.text!==undefined?h=e.text:h="motif, "+e.start+" - "+e.end;var p=this._imageParams.xOffset,d=this._imageParams.yOffset,v={text:h,type:"motif",start:e.aliStart||e.start,end:e.aliEnd||e.end,colour:colour,coords:[p+r,d+i,p+r+n,d+i+t]};this._areasList.push(v),this._areasHash["motif_"+h+"_"+e.start+"_"+e.end]=v,e.href!==undefined&&(v.href=e.href),this._buildTip(e,v)},_buildRegionPath:function(e){switch(e.s){case"curved":this._context.moveTo(e.x+e.r,e.y),this._drawLeftRounded(e.x,e.y,e.r,e.h);break;case"jagged":this._context.moveTo(e.x,e.y),this._drawJagged(e.x,e.y,e.h,!0);break;case"straight":this._context.moveTo(e.x,e.y),this._context.lineTo(e.x,e.y+e.h);break;case"arrow":this._context.moveTo(e.x+e.a,e.y),this._drawLeftArrow(e.x,e.y,e.a,e.h)}switch(e.e){case"curved":this._context.lineTo(e.x+e.w-e.r,e.y+e.h),this._drawRightRounded(e.x,e.y,e.r,e.h,e.w);break;case"jagged":this._context.lineTo(e.x+e.w,e.y+e.h),this._drawJagged(e.x+e.w,e.y+e.h,e.h,!1);break;case"straight":this._context.lineTo(e.x+e.w,e.y+e.h),this._context.lineTo(e.x+e.w,e.y);break;case"arrow":this._context.lineTo(e.x+e.w-e.a,e.y+e.h),this._drawRightArrow(e.x+e.w-e.a,e.y+e.h,e.a,e.h)}e.s==="curved"||e.s==="arrow"?this._context.lineTo(e.x+e.r,e.y):this._context.lineTo(e.x,e.y)},_drawEnvelope:function(e,t,n){parseInt(e.start,10)>parseInt(e.aliStart,10)&&this._throw("regions must have start <= aliStart ("+e.start+" is > "+e.aliStart+")"),parseInt(e.end,10)<parseInt(e.aliEnd,10)&&this._throw("regions must have end >= aliEnd ("+e.end+" is < "+e.aliEnd+")");var r=this._baseline-t,i=this._imageParams.residueWidth,s,o;e.aliStart&&e.aliStart>e.start&&(s={x:Math.floor(e.start*i),y:Math.floor(r-1)+1,w:Math.floor(e.aliStart*i)-Math.floor(e.start*i)+1,h:n+1}),e.aliEnd&&e.aliEnd<e.end&&(o={x:Math.floor(e.aliEnd*i)+1,y:Math.floor(r-1)+1,w:Math.floor(e.end*i)-Math.floor(e.aliEnd*i),h:n+1}),this._context.save(),this._context.globalCompositeOperation="source-atop";var u="rgba(255,255,255,"+this._imageParams.envOpacity+")";this._context.fillStyle=u,s!==undefined&&this._context.fillRect(s.x,s.y,s.w,s.h),o!==undefined&&this._context.fillRect(o.x,o.y,o.w,o.h),this._context.restore()},_drawText:function(e,t,n,r){this._context.save(),this._context.font="bold 12px 'optimer'",this._context.textAlign="center",this._context.textBaseline="middle";var i=this._context.measureText(r),s=i.width+Math.round(this._regionHeight/3),o=i.height;if(s>n){this._context.restore();return}if(o>this._regionHeight){this._context.restore();return}var u=e+n/2;this._context.lineWidth=2,this._context.strokeStyle="#eeeeee",this._context.strokeText(r,u,t),this._context.fillStyle="#000000",this._context.fillText(r,u,t),this._context.restore()},_drawLeftRounded:function(e,t,n,r){this._context.quadraticCurveTo(e,t,e,t+n),this._context.quadraticCurveTo(e,t+r,e+n,t+r)},_drawRightRounded:function(e,t,n,r,i){this._context.quadraticCurveTo(e+i,t+r,e+i,t+n),this._context.quadraticCurveTo(e+i,t,e+i-n,t)},_drawJagged:function(e,t,n,r){var i=parseInt(this._imageParams.largeJaggedSteps,10);i+=i%2;var s=this._getSteps(n,i),o=n/i;for(var u=0;u<s.length;u+=1)u%2!==0?r?this._context.lineTo(e,t+s[u]):this._context.lineTo(e,t-s[u]):r?this._context.lineTo(e+o,t+s[u]):this._context.lineTo(e-o,t-s[u]);r?this._context.lineTo(e,t+n):this._context.lineTo(e,t-n)},_getSteps:function(e,t){var n="shifts_"+e+"_"+t,r=this._cache[n];if(r===undefined){var i=e/t,s=[];for(var o=0;o<t/2;o+=1)s.push(e/2-o*i),s.push(e/2+o*i);r=s.uniq().sort(function(e,t){return e-t}),this._cache[n]=r}return r},_drawLeftArrow:function(e,t,n,r){this._context.lineTo(e,t+n),this._context.lineTo(e+n,t+r)},_drawRightArrow:function(e,t,n,r){this._context.lineTo(e+n,t-r+n),this._context.lineTo(e,t-r)},_drawHighlight:function(){var e=this._imageParams.xOffset,t=this._imageParams.yOffset,n=Math.round(this._imageParams.highlightWeight/2),r=Math.floor(e+this._sequence.highlight.start*this._imageParams.residueWidth),i=Math.ceil(t+this._sequence.highlight.end*this._imageParams.residueWidth),s=this._canvasHeight-4-n,o=this._canvasHeight-2;this._imageParams.highlightWeight%2&&(r-=.5,i-=.5,o-=.5),this._context.save(),this._context.beginPath(),this._context.strokeStyle=this._imageParams.highlightColour,this._context.lineWidth=this._imageParams.highlightWeight,this._context.moveTo(r,s),this._context.lineTo(r,o),this._context.lineTo(i,o),this._context.lineTo(i,s),this._context.stroke(),this._context.restore();var u={start:this._sequence.highlight.start,end:this._sequence.highlight.end,coords:[r,s,i,o],tip:{title:this._sequence.highlight.text||"Highlighted region",body:'<div class="tipContent">  <dl>    <dt>Start:</dt>    <dd>'+this._sequence.highlight.start+"</dd>"+"    <dt>End:</dt>"+"    <dd>"+this._sequence.highlight.end+"</dd>"+"  </dl>"+"</div>"}};this._areasList.push(u)},_getRGBColour:function(e){var t=/^#?([A-F0-9]{6})$/i.exec(e),n=/^#?([A-F0-9]{3})$/i.exec(e),r,i,s,o,u;return t===null&&n===null&&this._throw("not a valid hex colour ('"+e+"')"),t!==null?(r=t[1],i=parseInt(r.substring(0,2),16),s=parseInt(r.substring(2,4),16),o=parseInt(r.substring(4,6),16)):n!==null&&(r=n[1],i=parseInt(""+r.substring(0,1)+r.substring(0,1),16),s=parseInt(""+r.substring(1,2)+r.substring(1,2),16),o=parseInt(""+r.substring(2,3)+r.substring(2,3),16)),u=[i,s,o],u.r=i,u.g=s,u.b=o,u},_getHexColour:function(e,t,n){var r,i,s;e.shift?(r=e[0],i=e[1],s=e[2]):e.r!==undefined&&e.g!==undefined&&e.b!==undefined?(r=e.r,i=e.g,s=e.b):(r=e,i=t,s=n);var o=[r,i,s].collect(function(e){return e===undefined&&this._throw("need all three RGB colour values"),isNaN(e)&&this._throw("failed to get a valid RGB colour triplet"),e=parseInt(e,10),e=Math.max(0,e),e=Math.min(e,255),e}),u=o.collect(function(e){return"0123456789abcdef".charAt((e-e%16)/16)+"0123456789abcdef".charAt(e%16)}).join("");return"#"+u}};this.PfamGraphic=PfamGraphic